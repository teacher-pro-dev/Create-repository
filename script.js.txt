const webcamVideo=document.getElementById("webcam"),flipBtn=document.getElementById("flipBtn"),pauseBtn=document.getElementById("pauseBtn"),recordBtn=document.getElementById("recordBtn"),saveBtn=document.getElementById("saveBtn"),timerDisplay=document.getElementById("timer"),questionSelect=document.getElementById("questionSelect"),customQuestionInput=document.getElementById("customQuestion");
const countdownDisplay=document.getElementById("countdown"),transcriptBox=document.getElementById("transcriptBox"),aiResultBox=document.getElementById("aiResultBox");
let stream,mediaRecorder,recordedChunks=[],isFlipped=!1,isPaused=!1,timerInterval=null,seconds=0,fullTranscript="";const SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;let recognition;if(SpeechRecognition){recognition=new SpeechRecognition;recognition.continuous=!0;recognition.interimResults=!0;recognition.lang="ko-KR";recognition.onresult=e=>{let t="",o="";for(let n=0;n<e.results.length;n++){const l=e.results[n][0].transcript;e.results[n].isFinal?o+=l:t+=l}transcriptBox.innerHTML=o+'<i style="color:#999;">'+t+"</i>";fullTranscript=o+t}}else{transcriptBox.textContent="현재 브라우저에서는 음성 인식을 지원하지 않습니다."}async function setupWebcam(){try{stream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});webcamVideo.srcObject=stream}catch(e){alert("카메라와 마이크에 접근할 수 없습니다. 권한을 확인해주세요."),console.error("Error accessing media devices.",e)}}
async function fetchTailQuestion(apiKey, question, answer){const apiUrl=`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`,prompt=`당신은 대학교의 날카로운 면접관입니다. 다음 [면접 질문]과 [학생의 답변]을 분석하여, 답변 내용에 기반한 심층적인 '꼬리 질문'을 딱 한 개만 생성하세요. 질문 문장 자체만 간결하게 한국어로 응답하세요. [면접 질문]: ${question} [학생의 답변]: ${answer}`;try{const response=await fetch(apiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})});if(!response.ok)throw new Error("꼬리 질문 API 오류");const data=await response.json();return data.candidates[0].content.parts[0].text.trim()}catch(e){console.error(e);return"꼬리 질문 생성 중 오류가 발생했습니다."}}
async function fetchApiFeedback(apiKey, question, answer){const apiUrl=`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`,prompt=`당신은 친절하고 유능한 대입 면접 컨설턴트입니다. 다음 [면접 질문]과 [학생의 답변]을 듣고, 학생의 성장을 도울 수 있는 구체적이고 건설적인 종합 피드백을 제공해주세요. - 피드백은 반드시 한국어로 작성해주세요. - Markdown을 사용하여 '칭찬할 점', '개선할 점', '총평' 세 부분으로 명확히 나누어 설명해주세요. - 학생이 자신감을 잃지 않도록 긍정적이고 부드러운 어조를 사용해주세요. [면접 질문]: ${question} [학생의 답변]: ${answer}`;try{const response=await fetch(apiUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})});if(!response.ok)throw new Error("피드백 API 오류");const data=await response.json();return data.candidates[0].content.parts[0].text.trim()}catch(e){console.error(e);return"AI 피드백 생성 중 오류가 발생했습니다."}}
async function displayAiResults(){const apiKey="YOUR_GOOGLE_AI_API_KEY";if(apiKey==="YOUR_GOOGLE_AI_API_KEY"){aiResultBox.innerHTML='<span style="color:red;">오류: Google AI API 키를 입력해야 합니다.</span>';return}let currentQuestion=questionSelect.value;if(currentQuestion==="custom"){currentQuestion=customQuestionInput.value}if(fullTranscript.trim().length<10){aiResultBox.innerHTML="답변이 너무 짧아 AI 분석을 진행할 수 없습니다.";return}aiResultBox.innerHTML='<div class="loader"></div>';const[tailQuestion,feedback]=await Promise.all([fetchTailQuestion(apiKey,currentQuestion,fullTranscript),fetchApiFeedback(apiKey,currentQuestion,fullTranscript)]);aiResultBox.innerHTML=`<div class="tail-question"><h4>꼬리 질문</h4><p>${tailQuestion}</p></div><div class="feedback"><h4>종합 피드백</h4><p>${feedback.replace(/\n/g,"<br>")}</p></div>`}
function formatTime(e){const t=Math.floor(e/60),o=e%60;return`${String(t).padStart(2,"0")}:${String(o).padStart(2,"0")}`}
flipBtn.addEventListener("click",()=>{isFlipped=!isFlipped,webcamVideo.style.transform=isFlipped?"scaleX(1)":"scaleX(-1)"});
pauseBtn.addEventListener("click",()=>{if(isPaused){webcamVideo.play();pauseBtn.innerHTML="⏸️";if(timerInterval===null&&seconds>0){timerInterval=setInterval(()=>{seconds++;timerDisplay.textContent=formatTime(seconds)},1000)}}else{webcamVideo.pause();pauseBtn.innerHTML="▶️";clearInterval(timerInterval);timerInterval=null}isPaused=!isPaused});
recordBtn.addEventListener("click",()=>{if(mediaRecorder&&"recording"===mediaRecorder.state){mediaRecorder.stop();recognition&&recognition.stop();recordBtn.innerHTML="녹화";recordBtn.title="녹화 시작";recordBtn.classList.remove("recording");saveBtn.disabled=!1;clearInterval(timerInterval)}else{let e=3;countdownDisplay.style.display="block";countdownDisplay.textContent=e;recordBtn.disabled=!0;const t=setInterval(()=>{e--;if(e>0)countdownDisplay.textContent=e;else{clearInterval(t);countdownDisplay.style.display="none";recordBtn.disabled=!1;recordedChunks=[];mediaRecorder=new MediaRecorder(stream);mediaRecorder.ondataavailable=e=>{e.data.size>0&&recordedChunks.push(e.data)};
mediaRecorder.onstop = displayAiResults;
mediaRecorder.start();recognition&&recognition.start();fullTranscript="";transcriptBox.textContent="음성 인식이 여기에 표시됩니다...";aiResultBox.innerHTML="답변을 마치면 이곳에서 AI의 분석 결과를 확인할 수 있어요.";recordBtn.innerHTML="종료";recordBtn.title="녹화 종료";record.classList.add("recording");saveBtn.disabled=!0;seconds=0;timerDisplay.textContent="00:00";clearInterval(timerInterval);timerInterval=setInterval(()=>{seconds++;timerDisplay.textContent=formatTime(seconds)},1000)}},1000)}});
saveBtn.addEventListener("click",()=>{const e=new Blob(recordedChunks,{type:"video/webm"}),t=URL.createObjectURL(e),o=document.createElement("a");document.body.appendChild(o);o.style="display: none";o.href=t;const n=document.getElementById("department").value||"면접연습",l=new Date().toISOString().slice(0,10);o.download=`${n}_${l}.webm`,o.click(),window.URL.revokeObjectURL(t),document.body.removeChild(o)});
questionSelect.addEventListener("change",()=>{customQuestionInput.style.display=questionSelect.value==="custom"?"block":"none"});
window.addEventListener("load",setupWebcam);